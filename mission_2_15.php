<html>
<link rel="stylesheet" href="style3.css">
<center><p style=" font-family: Arial;font-size: 30px; color: #97c242;">このサイトの評価をしてください</p></center>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="expires" content="0" />

<?php
	//セッションの復元
	session_start();
	$data1 = $_SESSION['name'];
	$pass = $_SESSION['pass'];
?>

<?php //password判定
    if(!empty($_POST['key'])){
	$key = $_POST['key'];
	if(!empty($_POST['number'])){
		$id = $_POST['number'];
	}else if(!empty($_POST['delete'])){
		$id = $_POST['delete'];
	}
			$dsn = '******';
			$user = '*****';
			$password = '******';
	
			try {
		//データベースに接続
		$pdo = new PDO($dsn,$user,$password);
			//echo "接続完了<br>";
		//tbtestの全カラム(列)を取り出す
		$sql = "SELECT * FROM keiji WHERE id = ?";
		$stmt = $pdo->prepare($sql);
		$stmt->bindValue(1, $id, PDO::PARAM_INT);
		$stmt->execute();
		$result = $stmt->fetch(PDO::FETCH_ASSOC);
		//print_r($result);
		$password = $result[password];
		if($password === $key){
			$match = "match";
			//echo "$match";
		}else if($password != $key){
			echo "パスワードが一致しません<br>";
		}
			$pdo = null;
			}catch (Exception $e) {
			 echo "エラー発生：" . htmlspecialchars($e->getMessage(), ENT_QUOTES, 'UTF-8') . "<br>";
			 die();
		
		}
	}else if(empty($_POST['key']) && (!empty($_POST['number']) or !empty($_POST['delete']) )){
		echo "パスワードを入力してください1"."<br>";
}
?>


<?php  //削除する
		//echo $_GET['delete'];
	if(!empty($_GET['delete'])){
			$id =(int)$_GET['delete'];
			$password = $_POST['password'];

				$dsn = '******';
				$user = '******';
				$password = '*****';

				try{
				//データベースに接続
				$pdo = new PDO($dsn,$user,$password);
				
				//プレースホルダを指定してDELETEのSQLを入力
				$sql = "DELETE FROM keiji WHERE id= ? AND password=?";  
				//SQLを実行する準備を入力
				$stmt = $pdo->prepare($sql);
				$stmt->bindValue(1, $id, PDO::PARAM_INT);
				$stmt->bindValue(2, $pass, PDO::PARAM_INT);
				$stmt->execute();
				
				
				$sql = "ALTER TABLE keiji DROP COLUMN id";
				$stmt = $pdo -> query($sql);
				$sql = "ALTER TABLE keiji ADD id INT(11) PRIMARY KEY AUTO_INCREMENT FIRST";
				$stmt = $pdo -> query($sql);
				$pdo = null;
				
				
					}catch (Exception $e) {
					 echo "エラー発生：" . htmlspecialchars($e->getMessage(), ENT_QUOTES, 'UTF-8') . "<br>";
					 die();
						}
  		}	
?>

<?php //編集番号で指定された名前とコメントを取得
	if(!empty($_GET['number'])){
		$id =(int)$_GET['number'];
		
		$dsn = '******';
		$user = '*****';
		$password = '*****';
		
		try {
		//データベースに接続
		$pdo = new PDO($dsn,$user,$password);
			//echo "接続完了<br>";
		//tbtestの全カラム(列)を取り出す
		$sql = "SELECT * FROM keiji WHERE id = ? AND password = ?";
		$stmt = $pdo->prepare($sql);
		$stmt->bindValue(1, $id, PDO::PARAM_INT);
		$stmt->bindValue(2, $pass, PDO::PARAM_INT);
		$stmt->execute();
		$result = $stmt->fetch(PDO::FETCH_ASSOC);
		//print_r($result);
		if(!empty($result)){
		$data1 = $result[name];
		$data2 = $result[comment];
		$key_re =  $result[password];
		$edit_num = $id;
		}
			$pdo = null;
			}catch (Exception $e) {
			 echo "エラー発生：" . htmlspecialchars($e->getMessage(), ENT_QUOTES, 'UTF-8') . "<br>";
			 die();
		}
	}
?>


<?php    //編集する名前とコメントを保存
	//echo $_POST['edit'];
	if(!empty($_POST['edit']) ){
		//echo "編集モードになっている";
		$name = $_POST['name'];
		$comment = $_POST['comment'];
		$id=$_POST['edit'];

				$dsn = '*****';
				$user = '*****';
				$password = '*****';
				
				try {
				//データベースに接続
				$pdo = new PDO($dsn,$user,$password);
					//echo "接続完了";
				$sql = "UPDATE keiji SET name = ?, comment = ? WHERE id = ?";
				$stmt = $pdo->prepare($sql);
				$stmt->bindValue(1,$name, PDO::PARAM_STR);
				$stmt->bindValue(2,$comment,PDO::PARAM_STR);
				$stmt->bindValue(3,$id, PDO::PARAM_INT);
				//指定したSQLを実行する
				$stmt -> execute();
				
				$pdo = null;
				}catch (Exception $e) {
					 echo "エラー発生：" . htmlspecialchars($e->getMessage(), ENT_QUOTES, 'UTF-8') . "<br>";
					 die();
				}
	}
?>

<?php
	if(!empty($_FILES["upfile"])  && empty($_POST['edit'])){
	//echo "ifに入れている";
				$f1 = htmlspecialchars($_POST['name']);
				$f2 = nl2br(htmlspecialchars($_POST['comment']));
				
				//時間の取得
				date_default_timezone_set('Asia/Tokyo');//世界基準表示から東京表示に直す
				$time = date("Y/m/d H:i:s",time());
				$upfile = $_FILES['upfile']['tmp_name'];
				//echo $upfile;
				// ファイル取得
				$imgdat = file_get_contents($upfile);
				$imgdat = mysql_real_escape_string($imgdat);
	
	
				//画像ファイルの指定
				$img_file = $_FILES["upfile"]["name"];;
				//echo "$img_file";
				//拡張子の取得
				$file_info = pathinfo($img_file);
				$img_extension = strtolower($file_info['extension']);
				//出力
				//echo $img_extension."<br>";
	
				$dsn = '*****';
				$user = '*****';
				$password = '*****';
				
				try {
				//データベースに接続
				$pdo = new PDO($dsn,$user,$password);
					//echo "接続完了";
				$sql = "INSERT INTO keiji (name,comment,time,password,img,ext) VALUES ('$f1','$f2','$time','$pass','$imgdat','$img_extension')";
				
				$stmt = $pdo->query($sql);
				
				clearstatcache();
				
				$pdo = null;
				}catch (Exception $e) {
					 echo "エラー発生：" . htmlspecialchars($e->getMessage(), ENT_QUOTES, 'UTF-8') . "<br>";
					 die();
     		}
	}
?>

<?php  //表示させるプログラム
$dsn = '*****';
$user = '*****';
$password = '*****';

try {
//データベースに接続
$pdo = new PDO($dsn,$user,$password);
	//echo "接続完了<br>";
//tbtestの全カラム(列)を取り出す
$sql = 'SELECT * FROM keiji';
$results = $pdo -> query($sql);
foreach ($results as $row){
    //$rowの中にはテーブルのカラム名が入る
    echo "<div id = \"form\">";
    echo $row['id'].'.';
    echo $row['name'].'<br>';
    //echo "&nbsp;";
    echo '<big>'.$row['comment'].'</big>'.'<br>';
    if(!empty($row[ext]) && $row[ext]=="jpg"){
    	$id = $row['id'];
    	print("<img src=\"img_get.php?id=" . $id . "\" width=\"193\" height=\"130\"></img><br>");
 
    }else if(!empty($row[ext]) && $row[ext]=="mp4"){
    	$id = $row['id'];
    	print("<video src=\"mp4_get.php?id=" . $id . "\" width=\"193\" height=\"130\"  controls></video><br>");
    }
    echo $row['time'].'<br>';
    print("<a href=\"mission_2_15.php?delete=" . $row['id']. "\">[削除]</a>");
    echo "&nbsp;";
	print("<a href=\"mission_2_15.php?number=" . $row['id']. "\">[編集]</a>");
	echo "</div>";
	}
	$pdo = null;
	}catch (Exception $e) {
	 echo "エラー発生：" . htmlspecialchars($e->getMessage(), ENT_QUOTES, 'UTF-8') . "<br>";
	 die();
}
?>
</body>
<hr>
<link rel="stylesheet" href="style2.css">
<title>U・Iブログ</title>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
	<form method="POST" enctype="multipart/form-data" action="mission_2_15.php">
	<div id ="form">
	<body>
	<p class = "name">名前 :</p>
	<input type="text" name="name" value = "<?php echo $data1; ?>"><br>
	<br><p class = "id">コメント :</p>
	<textarea name = "comment" cols = "90" rows = "10" maxlength="120"><?php echo $data2; ?></textarea>
	<input type = "hidden" name = "edit" value = "<?php echo $edit_num; ?>">
	<input type="hidden" name="number1" value = "<?php echo $f4; ?>" ><br>
	<br><p class = "id">アップロード :<p>
	<INPUT type="file" name="upfile" >
	<p class = "submit"><INPUT type="submit" name="submit" value="送信"></p>
	</form>
	</div>
</body>
<center><a href="logout.php">[ログアウト]</a></center>
</html>